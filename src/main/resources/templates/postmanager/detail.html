<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사후관리 소견서 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        /* 테이블은 Bootstrap의 기본 구조 유지 */

        .after-chart-container {
            width: 100%;
            margin-top: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .charts-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }


        .chart-card {
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .chart-card canvas {
            width: 100% !important;
            height: 260px !important;
        }
    </style>
</head>
<body>

<h1>사후관리 소견서 상세</h1>

<!-- ============================
     1. 근로자 기본정보
============================= -->
<h2>직원 정보</h2>

<table class="table table-bordered">
    <thead class="table-light">
    <tr>
        <th style="width: 150px;">항목</th>
        <th>내용</th>
    </tr>
    </thead>

    <tbody>
    <tr><th>이름</th><td th:text="${detail.name}"></td></tr>
    <tr><th>부서</th><td th:text="${detail.department}"></td></tr>
    <tr><th>직군</th><td th:text="${detail.occupation}"></td></tr>
    </tbody>
</table>


<!-- ============================
     2. 건강검진 정보 리스트
============================= -->
<h2>일반건강검진 이력</h2>

<table class="table table-bordered">
    <thead class="table-light">
    <tr>
        <th>검진년도</th>
        <th>고혈압 분류</th>

        <th>당뇨</th>

        <th>지질</th>

        <th>간장질환(등급)</th>

        <th>신장질환(등급)</th>
        <th>요단백</th>

        <th>비만</th>

        <th>흡연</th>
        <th>음주</th>
        <th>근골격계 질환</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="item : ${detail.generalCheckupDetail}">
        <td th:text="${item.examYear}"></td>
        <td th:text="${item.highBloodPressureGrade}"></td>

        <td th:text="${item.diabetesGrade}"></td>

        <td th:text="${item.lipidGrade}"></td>

        <td th:text="${item.liverDiseaseGrade}"></td>

        <td th:text="${item.kidneyDiseaseGrade}"></td>
        <td th:text="${item.urineProtein}"></td>

        <td th:text="${item.obesityGrade}"></td>

        <td th:text="${item.smokingYn == 'Y' ? '흡연' : '비흡연'}"></td>
        <td th:text="${item.drunkenYn == 'Y' ? '음주' : '술을 마시지 않음'}"></td>
        <td th:text="${item.musculoskeletalGrade}"></td>

    </tr>
    </tbody>
</table>


<!-- ============================
     3. 그래프 영역
============================= -->
<div class="after-chart-container">
    <div class="charts-grid">

        <!-- 혈압 -->
        <div class="chart-card">
            <div class="chart-title">혈압 추이</div>
            <canvas id="bpChart"></canvas>
            <div id="bpNoData" class="no-data" style="display:none;">데이터 없음</div>
            <div id="bpTable" class="mt-3"></div>
        </div>

        <!-- 공복혈당 -->
        <div class="chart-card">
            <div class="chart-title">당뇨 추이</div>
            <canvas id="diabetesChart"></canvas>
            <div id="diabetesNoData" class="no-data" style="display:none;">데이터 없음</div>
            <div id="diabetesTable" class="mt-3"></div>
        </div>

        <!-- 지질 -->
        <div class="chart-card">
            <div class="chart-title">이상지질 추이</div>
            <canvas id="lipidChart"></canvas>
            <div id="lipidNoData" class="no-data" style="display:none;">데이터 없음</div>
            <div id="lipidTable" class="mt-3"></div>
        </div>

        <!-- 신장 -->
        <div class="chart-card">
            <div class="chart-title">신장질환 추이</div>
            <canvas id="kidneyDiseaseChart"></canvas>
            <div id="kidneyDiseaseNoData" class="no-data" style="display:none;">데이터 없음</div>
            <div id="kidneyTable" class="mt-3"></div>
        </div>

        <!-- 간장 -->
        <div class="chart-card">
            <div class="chart-title">간장질환 추이</div>
            <canvas id="liverChart"></canvas>
            <div id="liverNoData" class="no-data" style="display:none;">데이터 없음</div>
            <div id="liverTable" class="mt-3"></div>
        </div>

        <!-- BMI -->
        <div class="chart-card">
            <div class="chart-title">비만 추이</div>
            <canvas id="bmiChart"></canvas>
            <div id="bmiNoData" class="no-data" style="display:none;">데이터 없음</div>
            <div id="bmiTable" class="mt-3"></div>
        </div>

    </div>
</div>

<!-- ============================
     3. 특수건강검진 이력
============================= -->
<h2 class="mt-4">특수건강검진 이력</h2>

<table class="table table-bordered">
    <thead class="table-light">
    <tr>
        <th>검진년도</th>
        <th>작업환경유해요인</th>
        <th>판정결과</th>
        <th>청력</th>
        <th>폐기능</th>
        <th>혈액검사</th>
        <th>소변검사</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="sp : ${detail.specialCheckupDetail}">
        <td th:text="${sp.examYear}"></td>
        <td th:text="${sp.hazardFactor}"></td>
        <td th:text="${sp.resultGrade}"></td>
        <td th:text="${sp.hearing}"></td>
        <td th:text="${sp.lungFunction}"></td>
        <td th:text="${sp.bloodTest}"></td>
        <td th:text="${sp.urineTest}"></td>
    </tr>
    </tbody>
</table>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">

    const allCheckups = /*[[${detail.generalCheckupDetail}]]*/ [];

    document.addEventListener('DOMContentLoaded', function () {

        /** ---------- 최근 3년 데이터 추출 ---------- **/
        const sorted = (Array.isArray(allCheckups) ? allCheckups : [])
            .filter(it => it && it.examYear)
            .sort((a, b) => Number(b.examYear) - Number(a.examYear))
            .slice(0, 3)
            .reverse();

        const labels = sorted.map(it => it.examYear);

        const toNumberOrNull = (v) => {
            if (v === null || v === undefined) return null;
            const n = Number(String(v).trim());
            return Number.isFinite(n) ? n : null;
        };

        /** ---------- 값 매핑 ---------- **/
        const systolic = sorted.map(it => toNumberOrNull(it.systolic));
        const diastolic = sorted.map(it => toNumberOrNull(it.diastolic));

        const fasting = sorted.map(it => toNumberOrNull(it.fastingBloodSugar));

        const totalChol = sorted.map(it => toNumberOrNull(it.totalCholesterol));
        const triglyceride = sorted.map(it => toNumberOrNull(it.triglyceride));
        const hdl = sorted.map(it => toNumberOrNull(it.hdl));
        const ldl = sorted.map(it => toNumberOrNull(it.ldl));

        const gfr = sorted.map(it => toNumberOrNull(it.gfr));
        const creatinine = sorted.map(it => toNumberOrNull(it.creatinine));

        const ast = sorted.map(it => toNumberOrNull(it.ast));
        const alt = sorted.map(it => toNumberOrNull(it.alt));
        const gtp = sorted.map(it => toNumberOrNull(it.gtp));

        const bmi = sorted.map(it => toNumberOrNull(it.bmi));
        const waist = sorted.map(it => toNumberOrNull(it.waist));

        /** ---------- 공통 차트 생성 함수 ---------- **/
        function createLineChart(canvasId, noDataId, datasets) {
            const canvas = document.getElementById(canvasId);
            const nodataEl = document.getElementById(noDataId);

            const hasAnyValue = datasets.some(ds => ds.data.some(v => v !== null));
            if (!labels.length || !hasAnyValue) {
                canvas.style.display = 'none';
                nodataEl.style.display = 'block';
                return;
            }
            nodataEl.style.display = 'none';
            canvas.style.display = 'block';

            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false } }
                }
            });
        }

        /** ---------- 공통 테이블 자동 생성 ---------- **/
        function renderTable(targetId, labels, ...columns) {
            const container = document.getElementById(targetId);
            if (!container) return;

            let html = `
                <table class="table table-bordered table-sm mt-2">
                <thead>
                    <tr>
                        <th>년도</th>
                        ${columns.map(c => `<th>${c.label}</th>`).join("")}
                    </tr>
                </thead>
                <tbody>
            `;

            labels.forEach((year, i) => {
                html += `<tr><td>${year}</td>`;
                columns.forEach(c => {
                    html += `<td>${c.data[i] ?? '-'}</td>`;
                });
                html += `</tr>`;
            });

            html += "</tbody></table>";

            container.innerHTML = html;
        }

        /** ---------- 차트 + 테이블 렌더링 ---------- **/

        // 혈압
        createLineChart('bpChart', 'bpNoData', [
            { label: '수축기', data: systolic },
            { label: '이완기', data: diastolic }
        ]);
        renderTable("bpTable", labels,
            { label: "수축기", data: systolic },
            { label: "이완기", data: diastolic }
        );

        // 당뇨
        createLineChart('diabetesChart', 'diabetesNoData', [
            { label: '공복혈당', data: fasting }
        ]);
        renderTable("diabetesTable", labels,
            { label: "공복혈당", data: fasting }
        );

        // 지질
        createLineChart('lipidChart', 'lipidNoData', [
            { label: '총콜레스테롤', data: totalChol },
            { label: '중성지방', data: triglyceride },
            { label: 'HDL', data: hdl },
            { label: 'LDL', data: ldl }
        ]);
        renderTable("lipidTable", labels,
            { label: '총콜레스테롤', data: totalChol },
            { label: '중성지방', data: triglyceride },
            { label: 'HDL', data: hdl },
            { label: 'LDL', data: ldl }
        );

        // 신장
        createLineChart('kidneyDiseaseChart', 'kidneyDiseaseNoData', [
            { label: 'GFR', data: gfr },
            { label: '크레아틴', data: creatinine }
        ]);
        renderTable("kidneyTable", labels,
            { label: 'GFR', data: gfr },
            { label: '크레아틴', data: creatinine }
        );

        // 간장
        createLineChart('liverChart', 'liverNoData', [
            { label: 'AST', data: ast },
            { label: 'ALT', data: alt },
            { label: 'GTP', data: gtp }
        ]);
        renderTable("liverTable", labels,
            { label: 'AST', data: ast },
            { label: 'ALT', data: alt },
            { label: 'GTP', data: gtp }
        );

        // BMI
        createLineChart('bmiChart', 'bmiNoData', [
            { label: 'BMI', data: bmi },
            { label: '허리둘레', data: waist }
        ]);
        renderTable("bmiTable", labels,
            { label: "BMI", data: bmi },
            { label: "허리둘레", data: waist }
        );

    });
</script>

</body>
</html>
